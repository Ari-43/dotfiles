#!/usr/bin/env bash
sudo echo -n

function sourceife () {
	if [ -f "$1" ]; then
		source "$@"
	fi
}

# Run if command exists
function runifce () {
	if [ -f "$(which $1)" ]; then
		"$@"
	fi
}

function runife () {
	if [ -f "$1" ]; then
		"$@"
	fi
}

function boxline () {
	printf '%.sâ”€' $(seq 1 $(tput cols))
}

useaur=1
aurhelper='paru'
useflatpak=1
userustup=1
useprotonup=1
useprotonrtsp=1
usefwupd=1

sourceife /etc/os-release
sourceife $HOME/.config/sysupdate/config

if [[ $userustup == 1 ]]; then
	boxline
	echo 'Updating rust packages with rustup...'
	runifce rustup update
fi
if [[ $ID == 'arch' ]]; then
	if [[ $useaur = 1 ]]; then
		boxline
		echo 'Updating Pacman and AUR packages...'
		runifce $aurhelper -Syu
	else
		boxline
		echo 'Updating Pacman packages...'
		sudo pacman -Syu
	fi
fi
if [[ $useflatpak == 1 ]]; then
	boxline
	echo 'Updating Flatpak packages...'
	runifce flatpak upgrade
fi
if [[ $useprotonup == 1 ]]; then
	boxline
	echo 'Updating Proton-GE...'
	runifce protonup-rs --quick-download 
fi
if [[ $useprotonrtsp == 1 ]]; then
	boxline
	echo 'Updating Proton-GE-RTSP for VRChat...'
	runife ~/.local/share/Steam/compatibilitytools.d/update-proton-ge-rtsp.sh
fi
if [[ $usefwupd == 1 ]]; then
	boxline
	echo 'Updating firmware with fwupd...'
	if which fwupdmgr >/dev/null; then
		sudo fwupdmgr refresh 2>/dev/null
		sudo fwupdmgr update
		sudo fwupdmgr activate 2>/dev/null
	fi
fi

boxline
read -p 'All updates complete'
